---
title: "Modelos estadísticos II: Modelos lineales generalizados"
subtitle: "Técnicas estadísticas avanzadas para la conservación de la biodiversidad - Universidad de Huelva"
author: "David García Callejas"
date: "01/2021"
output:
  beamer_presentation:
    theme: "metropolis"
    highlight: zenburn
fontsize: 10pt
header-includes:
- \usepackage{caption}
- \captionsetup[figure]{labelformat=empty}
- \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(options$size != "normalsize", paste0("\n \\", options$size,"\n\n", x, "\n\n \\normalsize"), x)
})
knitr::opts_chunk$set(echo = TRUE, warnings = FALSE, message = FALSE, size = "small")
library(tidyverse)
library(patchwork)
library(visreg)
set.seed(42)
```

## Modelos lineales generalizados

>- Hasta ahora: modelos lineales con variable respuesta **continua** y residuos **normales**

>- ¿podemos modelar variables con respuestas discretas? Por ejemplo, mortalidad de peces en función de tiempo de exposición a temperaturas de 5ºC:

```{r}
gupp <- read.csv(here::here("datasets",
                            "chap17f9_1GuppyColdDeath.csv"))
head(gupp)
```

## Modelos lineales generalizados

```{r out.width="70%"}
ggplot(gupp, aes(x = exposureDurationMin,y = mortality)) +
  geom_point(position = position_jitter(width = .3,height = .03))
```

## Modelos lineales generalizados

* ¿Podemos aplicar una regresión lineal a estos datos?

>    - ¿la relación entre X e Y es lineal?
>    - ¿esperamos que los residuos sean normales?

## Modelos lineales generalizados

```{r out.width="70%"}
lmgupp <- lm(mortality ~ exposureDurationMin, data = gupp)
ggplot(gupp, aes(x = exposureDurationMin,y = mortality)) +
  geom_point(position = position_jitter(width = .3,height = .03)) + 
  geom_smooth(method = "lm")
```

## Modelos lineales generalizados

>- Para valores muy bajos o muy altos de exposición, la mortalidad es **< 0** o **> 1**
>- ¿y los residuos?

## Modelos lineales generalizados

* Para valores muy bajos o muy altos de exposición, la mortalidad es **< 0** o **> 1**
* ¿y los residuos?

```{r echo=FALSE, out.width="80%"}
plot(lmgupp,which = 1)
```

## Modelos lineales generalizados

* Para valores muy bajos o muy altos de exposición, la mortalidad es **< 0** o **> 1**
* ¿y los residuos?

```{r echo=FALSE, out.width="80%"}
hist(resid(lmgupp))
```

## Modelos lineales generalizados

En este caso, queremos modelar la probabilidad de mortalidad en función del tiempo de exposición a temperaturas bajas, con una función limitada entre 0 y 1

```{r echo=FALSE, out.width="70%", fig.align="center"}
knitr::include_graphics(here::here("figuras","linear_logistic_regression.png"))
```

## Modelos lineales generalizados

```{r echo=FALSE, out.width="80%"}
binomial_smooth <- function(...) {
  geom_smooth(method = "glm", method.args = list(family = "binomial"), ...)
}

ggplot(gupp, aes(x = exposureDurationMin,y = mortality)) +
  geom_point(position = position_jitter(width = .3,height = .03)) + 
  binomial_smooth()
```

## Modelos lineales generalizados

Este tipo de modelos, que permiten modelar respuestas *no normales*, se llaman **Modelos lineales generalizados** (*Generalized Linear Models*, GLM).

Tienen tres componentes:

>- Distribución estadística de la variable respuesta
>- Variables predictoras
>- Función de enlace

## Modelos lineales generalizados

>- En un modelo con variable respuesta **binaria**, la distribución es la distribución **binomial**.
>- Las variables predictoras son equivalentes a un modelo lineal.
>- La función de enlace nos permite modelar nuestra respuesta $a + b \cdot x_i$ en el intervalo $[0,1]$, en vez de que tome cualquier valor entre $[-\infty,\infty]$

## Modelos lineales generalizados

* Función de enlace

Usamos la función logística: 

$$Pr(mortalidad_i) = \frac{e^{a + bx_i}}{1 + e^{a + bx_i}}$$

* La función enlace se aplica a la variable respuesta, por lo que reordenamos la ecuación previa:

\begin{gather}
Pr(mortalidad_i) = p_i = g(a + bx_i)\notag\\
g^{-1}(p_i) = a + bx_i
\end{gather}

## Modelos lineales generalizados

La función inversa de la logística se llama "logit". Esta, por fin, es nuestra función de enlace:

$$logit(p_i) = a + bx_i$$
De esta manera, para cualquier valor de $a, b, x_i$, la respuesta estará acotada entre $[0,1]$.

## Modelos lineales generalizados

**Función de enlace**: Transforma la estimación del modelo para que se ajuste a la distribución de la variable respuesta.

## Modelos lineales generalizados

* Ya tenemos todos los ingredientes para ajustar nuestro primer GLM

```{r}
glm1 <- glm(mortality ~ exposureDurationMin, 
            data = gupp, 
            family = "binomial")
```

que se corresponde con

\begin{gather}
logit(Pr(mortalidad_i)) =  a + b \cdot exposure_i\notag
\end{gather}

## Modelos lineales generalizados

```{r size="tiny"}
summary(glm1)
```

## Modelos lineales generalizados

```{r}
coef(glm1)
```

**Estos coeficientes están en escala logit**. No se pueden interpretar como probabilidades de manera directa, sino que debemos "deshacer" la función de enlace para recuperar probabilidades estándar. La función inversa de la logit es la función logística, que se aplica en R con el comando `plogis`. 

## Modelos lineales generalizados

Por ejemplo, si queremos saber la probabilidad de mortalidad de un pez en condiciones basales, sin exposición a temperaturas de 5ºC, el modelo sería:

\begin{gather}
logit(y_i) = a + b \cdot 0 = a\notag\\
y_i = plogis(a)
\end{gather}

En R: 

```{r}
a <- coef(glm1)[1]
plogis(a)
```

## Modelos lineales generalizados

O si queremos saber la probabilidad de mortalidad de un pez tras 12 minutos de exposición:
\begin{gather}
logit(y_i) = a + b \cdot 12 \notag\\
y_i = plogis(a + b \cdot 12)\notag
\end{gather}

```{r}
a <- coef(glm1)[1]; b <- coef(glm1)[2]
plogis(a + b*12)
```

Si el modelo es apropiado, esta probabilidad debe ser similar a las probabilidades obtenidas directamente de los datos:

```{r}
sum(gupp$mortality[gupp$exposureDurationMin == 12]) /
nrow(gupp[gupp$exposureDurationMin == 12,])
```

## Modelos lineales generalizados

Interpretar resultados: El paquete `effects` da los coeficientes en probabilidades

```{r}
library(effects)
allEffects(glm1)
```

## Modelos lineales generalizados

```{r}
plot(allEffects(glm1))
```

## Modelos lineales generalizados

* Comprobación de los residuos del modelo

```{r eval=FALSE}
plot(glm1)
```

```{r echo=FALSE, out.width="80%"}
plot(glm1,which = 1)
```

## Modelos lineales generalizados

* Comprobación de los residuos del modelo: paquete `DHARMa`

```{r results='hide', out.width="70%"}
library(DHARMa)
simulateResiduals(glm1,plot = TRUE)
```

## Modelos lineales generalizados

Pasos para generar GLMs:

>- Análisis exploratorio: Visualización de los datos
>- Ajuste del modelo (cuidado con el argumento "family"!)
>- Comprobación: `summary`, residuos (e.g. con `DHARMa`)
>- Transformar coeficientes (e.g. con `allEffects`)
>- Visualizar modelo (e.g. con `allEffects` o `visreg`)

## Modelos lineales generalizados

Los modelos de regresión logística se pueden aplicar también a datos de proporciones

```{r}
gupp.prop <- gupp %>% 
  group_by(exposureDurationMin) %>% 
  summarise(alive = sum(mortality == 0),
            dead = sum(mortality == 1))
```

```{r}
gupp.prop
```

## Modelos lineales generalizados

Ajustamos el modelo usando `cbind(positivos, negativos)` como variable respuesta. En este caso, la probabilidad es de mortalidad, por lo que nuestro "positivo" es el número de muertes.

```{r}
glm.prop <- glm(cbind(dead,alive) ~ exposureDurationMin, 
                data = gupp.prop, 
                family = "binomial")
```

```{r}
coef(glm1)
coef(glm.prop)
```

## Modelos lineales generalizados

* Otro ejemplo con datos de proporciones

```{r}
gdp <- read.csv(here::here("datasets",
                           "UN_GDP_infantmortality.csv"))
head(gdp)
```

## Modelos lineales generalizados

```{r out.width="80%", warning=FALSE}
ggplot(gdp, aes(x = gdp, y = mortality)) + 
  geom_point()
```

## Modelos lineales generalizados

```{r}
gdp.glm <- glm(cbind(mortality, 1000 - mortality) ~ gdp,
               data = gdp, family = binomial)
```

## Modelos lineales generalizados

```{r size="tiny"}
summary(gdp.glm)
```

## Modelos lineales generalizados

Coeficientes:

```{r}
allEffects(gdp.glm)
```

## Modelos lineales generalizados

Visualización del modelo:

```{r}
plot(allEffects(gdp.glm))
```

## Modelos lineales generalizados

Residuos:

```{r results='hide', out.width="80%"}
simulateResiduals(gdp.glm,plot = TRUE)
```

## Modelos lineales generalizados

Welcome to the real world!

```{r echo=FALSE, out.width="80%", fig.align="center"}
knitr::include_graphics(here::here("figuras","dicaprio.png"))
```

## Modelos lineales generalizados

Este patrón en los residuos indica **sobredispersión**. Los datos están más dispersos de lo que esperaríamos según el modelo. En este caso, para un gdp determinado, hay una variación muy grande en mortalidad infantil.

```{r out.width="70%"}
visreg(gdp.glm, scale = "response")
points(mortality/1000 ~ gdp, data = gdp)
```

## Modelos lineales generalizados

Podemos comprobar la sobredispersión (o infradispersión) de manera explícita con `DHARMa`:

```{r}
simres <- simulateResiduals(gdp.glm, refit = TRUE)
testDispersion(simres, plot = FALSE)
```

## Modelos lineales generalizados

La sobredispersión se puede tratar explicitamente escogiendo otra distribución para la variable respuesta. En este caso, la distribución *quasibinomial* ayuda a modelar esta varianza extra

```{r}
gdp.glm.qb <- glm(cbind(mortality, 1000 - mortality) ~ gdp,
               data = gdp, family = quasibinomial)
```

## Modelos lineales generalizados

* Los valores medios de los coeficientes se mantienen con respecto al modelo binomial

```{r}
allEffects(gdp.glm)
allEffects(gdp.glm.qb)
```
## Modelos lineales generalizados

* Pero los errores asociados sí varían

```{r}
plot(allEffects(gdp.glm),main = "binomial dist")
```


## Modelos lineales generalizados

* Pero los errores asociados sí varían

```{r}
plot(allEffects(gdp.glm.qb),main = "quasibinomial dist")
```

## Modelos lineales generalizados

Más allá de la solución concreta, este ejemplo nos ayuda a pensar en la forma de las relaciones entre variables. No todas las relaciones son de naturaleza lineal

```{r out.width="80%", warning=FALSE}
ggplot(gdp, aes(x = gdp, y = mortality)) + 
  geom_point()
```

## Modelos lineales generalizados

```{r echo=FALSE, out.width="95%", fig.align="center"}
knitr::include_graphics(here::here("figuras","transformaciones.png"))
```

## Modelos lineales generalizados

A veces es conveniente transformar la variable respuesta para acercarnos a una relación lineal

```{r out.width="80%", warning=FALSE}
ggplot(gdp, aes(x = log(gdp), y = mortality)) + 
  geom_point()
```

## Modelos lineales generalizados

```{r}
gdp.glm.log <- glm(cbind(mortality, 1000 - mortality) ~ log(gdp),
               data = gdp, family = quasibinomial)
```

## Modelos lineales generalizados

```{r out.width="80%"}
visreg(gdp.glm.log, scale = "response")
points(mortality/1000 ~ gdp, data = gdp)
```

## Modelos lineales generalizados

```{r eval=FALSE}
plot(gdp.glm.log)
```

```{r echo=FALSE, out.width="80%"}
plot(gdp.glm.log,which = 1)
```

## Modelos lineales generalizados

Este último modelo sigue sin ser ideal, pero con datos reales, a veces no es fácil llegar a modelos *perfectos*

## Modelos lineales generalizados

>- Ya conocemos la distribución normal $Y \sim N(\mu,\sigma^2)$, que es una distribución continua, y la binomial, que es una distribución discreta. Hay muchas otras distribuciones que podemos considerar para modelar datos ecológicos.

>- Uno de los tipos de datos más comunes que nos encontraremos son datos de conteos

## Modelos lineales generalizados

* Ya conocemos la distribución normal $Y \sim N(\mu,\sigma^2)$, que es una distribución continua, y la binomial, que es una distribución discreta. Hay muchas otras distribuciones que podemos considerar para modelar datos ecológicos.

* Uno de los tipos de datos más comunes que nos encontraremos son datos de conteos

```{r}
seedlings <- read.csv(here::here("datasets","seedlings.csv"))
head(seedlings)
```


## GLM

>- distribuciones continuas y discretas
>- likelihood (WS p814)
>- esquema general: distribución de residuos, fórmula, función de enlace
>- regresión logística (WS p701)
>- regresión de conteos (poisson, negbin)
>- selección de modelos (AIC)


